resources:
  jobs:
    ai_parse_document_job:
      name: ai_parse_document_job

      # Optional: Add a schedule
      # schedule:
      #   quartz_cron_expression: "0 0 * * * ?"
      #   timezone_id: "UTC"

      # Job-level parameters shared across all tasks
      parameters:
        - name: catalog
          default: ${var.catalog}
        - name: schema
          default: ${var.schema}
        - name: source_volume_path
          default: ${var.source_volume_path}
        - name: output_volume_path
          default: ${var.output_volume_path}
        - name: checkpoint_base_path
          default: ${var.checkpoint_base_path}
        - name: raw_table_name
          default: ${var.raw_table_name}
        - name: text_table_name
          default: ${var.text_table_name}
        - name: structured_table_name
          default: ${var.structured_table_name}

      environments:
        - environment_key: serverless_env
          spec:
            client: "3"

      tasks:
        - task_key: parse_documents
          environment_key: serverless_env
          notebook_task:
            notebook_path: ../src/transformations/01_parse_documents.py
            base_parameters:
              source_volume_path: "{{job.parameters.source_volume_path}}"
              output_volume_path: "{{job.parameters.output_volume_path}}"
              checkpoint_location: "{{job.parameters.checkpoint_base_path}}/01_parse_documents"
              table_name: "{{job.parameters.raw_table_name}}"

        - task_key: extract_text
          depends_on:
            - task_key: parse_documents
          environment_key: serverless_env
          notebook_task:
            notebook_path: ../src/transformations/02_extract_text.py
            base_parameters:
              checkpoint_location: "{{job.parameters.checkpoint_base_path}}/02_extract_text"
              source_table_name: "{{job.parameters.raw_table_name}}"
              table_name: "{{job.parameters.text_table_name}}"

        - task_key: extract_structured_data
          depends_on:
            - task_key: extract_text
          environment_key: serverless_env
          notebook_task:
            notebook_path: ../src/transformations/03_extract_structured_data.py
            base_parameters:
              checkpoint_location: "{{job.parameters.checkpoint_base_path}}/03_extract_structured_data"
              source_table_name: "{{job.parameters.text_table_name}}"
              table_name: "{{job.parameters.structured_table_name}}"

      max_concurrent_runs: 1
