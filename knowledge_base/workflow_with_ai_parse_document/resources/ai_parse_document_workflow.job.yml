resources:
  jobs:
    ai_parse_document_workflow:
      name: ai_parse_document_workflow

      # Optional: Add a schedule
      # schedule:
      #   quartz_cron_expression: "0 0 * * * ?"
      #   timezone_id: "UTC"

      # Job-level parameters shared across all tasks
      parameters:
        - name: catalog
          default: ${var.catalog}
        - name: schema
          default: ${var.schema}

      environments:
        - environment_key: serverless_env
          spec:
            client: "3"

      tasks:
        - task_key: parse_documents
          environment_key: serverless_env
          notebook_task:
            notebook_path: ../src/transformations/01_parse_documents.py
            base_parameters:
              source_volume_path: ${var.source_volume_path}
              output_volume_path: ${var.output_volume_path}
              checkpoint_location: ${var.checkpoint_base_path}/01_parse_documents
              table_name: ${var.raw_table_name}

        - task_key: extract_text
          depends_on:
            - task_key: parse_documents
          environment_key: serverless_env
          notebook_task:
            notebook_path: ../src/transformations/02_extract_text.py
            base_parameters:
              checkpoint_location: ${var.checkpoint_base_path}/02_extract_text
              source_table_name: ${var.raw_table_name}
              table_name: ${var.text_table_name}

        - task_key: extract_structured_data
          depends_on:
            - task_key: extract_text
          environment_key: serverless_env
          notebook_task:
            notebook_path: ../src/transformations/03_extract_structured_data.py
            base_parameters:
              checkpoint_location: ${var.checkpoint_base_path}/03_extract_structured_data
              source_table_name: ${var.text_table_name}
              table_name: ${var.structured_table_name}

      max_concurrent_runs: 1
